---
title: R Markdown Syntax Highlighting
author: Curtis Alexander
date: "2017-11-11"
slug: r-markdown-syntax-highlighting
categories: []
tags: 
  - r
---



<div id="prior-art" class="section level2">
<h2>Prior art</h2>
<p>In the <a href="http://curtisalexander.github.io/rmarkdown-syntax-highlighting/">past</a> I had explored using the <a href="https://github.com/yihui/highr">highr</a> package to enable syntax highlighting of languages that were not supported within <a href="http://rmarkdown.rstudio.com/">R Markdown</a>. I never loved the solution as it required one to download and setup <a href="http://www.andre-simon.de/doku/highlight/en/install.php">highlight</a>. In addition, the solution also required some manual steps to be run from the command line to include the appropriate css file as well.</p>
</div>
<div id="what-is-the-problem-again" class="section level2">
<h2>What is the problem again?</h2>
<p>Repeating my original problem — I want to have syntax highlighting for <a href="https://www.sas.com/">SAS</a> code within my R Markdown documents.</p>
<p>R Markdown relies on <a href="https://pandoc.org">pandoc</a> for its syntax highlighting. Specifically, the <a href="https://github.com/jgm/skylighting/">skylighting</a> Haskell library is utilized by <code>pandoc</code> for its highlighting. The list of languages that are supported can be found <a href="https://github.com/jgm/skylighting/tree/master/xml">here</a>.</p>
<div class="figure">
<img src="img/RMarkdownFlow.png" alt="Courtesy RStudio" />
<p class="caption"><em>Courtesy RStudio</em></p>
</div>
<p>RStudio <a href="http://rmarkdown.rstudio.com/lesson-2.html">provides</a> the nice illustration above describing how one begins with an R Markdown document and ends with an html document. <code>pandoc</code> is what ultimately performs sytnax highlighting using the aforementioned <code>skylighting</code> library.</p>
</div>
<div id="the-answercodemirror" class="section level2">
<h2>The answer…<a href="https://codemirror.net/">CodeMirror</a></h2>
<p>Rather than relying on <code>pandoc</code>, I determined a way to take advantage of the Javascript text editor <a href="https://codemirror.net/">CodeMirror</a> when producing html documents. Again, CodeMirror is a Javascript text editor that I simply set to be read only which serves as a form of syntax highlighting.</p>
<blockquote>
<p><strong>Aside</strong>: In the end the answer always seems to be Javascript. For many <a href="https://hackernoon.com/how-it-feels-to-learn-javascript-in-2016-d3a717dd577f">reasons</a>, I have avoided learning Javascript. But for my use case here, I must admit that Javascript is quite helpful!</p>
</blockquote>
</div>
<div id="r-markdown-example" class="section level2">
<h2>R Markdown Example</h2>
<p>To go straight to an example, take a look at either the <a href="https://raw.githubusercontent.com/curtisalexander/rmarkdown-with-alt-langs/master/rmarkdown-with-alt-langs.Rmd">R Markdown document</a> or the <a href="https://curtisalexander.github.io/rmarkdown-with-alt-langs/">rendered html</a>. This <a href="https://github.com/curtisalexander/rmarkdown-with-alt-langs/">repo</a> will be utilized throughout as an example.</p>
</div>
<div id="r-markdown-setup" class="section level2">
<h2>R Markdown Setup</h2>
<p>There are quite a few steps required but once they are all stitched together, they allow for SAS (and other language) syntax highlighting that wasn’t possible before.</p>
<div id="requirements" class="section level3">
<h3>Requirements</h3>
<p>The following R packages are required for the proposed solution.</p>
<ul>
<li><a href="https://cran.r-project.org/web/packages/stringr/index.html">stringr</a></li>
<li><a href="https://cran.r-project.org/web/packages/htmltools/">htmltools</a></li>
</ul>
<p>In addition, one will need access to the internet as the solution makes use of <code>&lt;script&gt;</code> tags to read in Javascript libraries from a <a href="https://www.cloudflare.com/cdn/">CDN</a>.</p>
</div>
<div id="code-mirror-javascriptcss" class="section level3">
<h3>Code Mirror Javascript/CSS</h3>
<p>There is a stylesheet and Javascript files provided by CodeMirror that need to be included. My preference is to create a <code>header.html</code> file and then make sure it is included within my <code>YAML</code> header.</p>
<p>Below is an example of the YAML header for <a href="https://raw.githubusercontent.com/curtisalexander/rmarkdown-with-alt-langs/master/rmarkdown-with-alt-langs.Rmd">rmarkdown-with-alt-langs</a>. Specifically take note of the <code>in_header</code> key.</p>
<pre class="yaml"><code>title: &quot;R Markdown with Alternate Languages&quot;
author: &quot;Curtis Alexander&quot;
output:
  html_document:
    include:
      in_header: header.html
    mathjax: null
params:
  hilang:
    - sas
    - crystal</code></pre>
<p>The file <a href="https://raw.githubusercontent.com/curtisalexander/rmarkdown-with-alt-langs/master/header.html">header.html</a> contains the following. Note that I used links to a CDN rather than directly pointing to CodeMirror.</p>
<pre class="html"><code>&lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.31.0/codemirror.min.css&quot;&gt;
&lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.31.0/codemirror.min.js&quot;&gt;&lt;/script&gt;
&lt;style&gt;
  .CodeMirror {
    border: 1px solid #eee;
    height: auto;
  }
&lt;/style&gt;</code></pre>
</div>
<div id="r-markdown-parameter" class="section level3">
<h3><a href="http://rmarkdown.rstudio.com/developer_parameterized_reports.html">R Markdown Parameter</a></h3>
<p>Within the <code>yaml</code> block above, the language(s) to be used for highlighting within the document is/are set with the <code>hilang</code> option. For a full list of all languages that can be utilized, take a look at the CodeMirror <a href="http://codemirror.net/mode/index.html">languages page</a>.</p>
</div>
<div id="hilang_setup.rmd" class="section level3">
<h3><code>_hilang_setup.Rmd</code></h3>
<p>Next, one needs to create a <a href="https://yihui.name/knitr/hooks/">knitr source hook</a> in order to wrap up the SAS code in <code>&lt;textarea&gt;</code> tags. The file <a href="https://raw.githubusercontent.com/curtisalexander/rmarkdown-with-alt-langs/master/_hilang_setup.Rmd">_hilang_setup.Rmd</a> contains two R code chunks, including the actual source hook.</p>
<p>The first R code chunk pulls in the needed Javascript from CodeMirror for the languages set within the <code>yaml</code> block. Note that this block requires the <code>asis</code> option to be set.</p>
<pre class="r"><code># take a character vector of parameters and inject
#   the appropriate script tag for code mirror
# ensures that the script tags are only inserted once
for(i in seq_along(params$hilang)) {
  js_mode &lt;- paste0(&quot;\n&lt;script src=\&quot;https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.31.0/mode/&quot;, tolower(params$hilang[i]), &quot;/&quot;, tolower(params$hilang[i]), &quot;.min.js\&quot;&gt;&lt;/script&gt;\n&quot;)
  cat(htmltools::htmlPreserve(js_mode))
}</code></pre>
<p>The second R code chunk sets the actual source hook.</p>
<pre class="r"><code>knitr::knit_hooks$set(source = function(x, options) {
  if (!is.null(options$hilang)) {
    textarea_id &lt;- paste(sample(LETTERS, 5), collapse = &quot;&quot;)
    code_open &lt;- paste0(&quot;\n\n&lt;textarea id=\&quot;&quot;, textarea_id, &quot;\&quot;&gt;\n&quot;)
    code_close &lt;- &quot;\n&lt;/textarea&gt;&quot;
    jscript_editor &lt;- paste0(&quot;\n&lt;script&gt; var codeElement = document.getElementById(\&quot;&quot;, textarea_id, &quot;\&quot;); var editor = null; if (null != codeElement) { editor = CodeMirror.fromTextArea(codeElement, { lineNumbers: true, readOnly: true, viewportMargin: Infinity, mode: &#39;text/x-&quot;, tolower(options$hilang), &quot;&#39; }); } &lt;/script&gt;\n&quot;)

    # if the option from_file is set to true then assume that
    #   whatever is in the code chunk is a file path
    if (!is.null(options$from_file) &amp;&amp; options$from_file) {
      code_body &lt;- readLines(file.path(x))
    } else {
      code_body &lt;- x
    }

    knitr::asis_output(
      htmltools::htmlPreserve(
        stringr::str_c(
          code_open,
          paste(code_body, collapse = &quot;\n&quot;),
          code_close,
          jscript_editor
        )
      )
    )
  } else {
    stringr::str_c(&quot;\n\n```&quot;, tolower(options$engine), &quot;\n&quot;, paste0(x, collapse = &quot;\n&quot;), &quot;\n```\n\n&quot;)
  }
})</code></pre>
<p>The source hook doesn’t have to be in a separate file. However, I like to include in a separate file so that within my relevant R Markdown document, I just need to include the following to bring it into scope within the document.</p>
<div class="sourceCode">
<pre class="sourceCode"><code class="sourceCode">```{r, child="_hilang_setup.Rmd"}
```</code></pre>
</div>
</div>
<div id="sas-code" class="section level3">
<h3>SAS Code</h3>
<p>Next is the easy part — just drop the SAS code into an R Markdown code chunk. A code chunk needs the following options to be set — <code>eval=FALSE</code> and <code>hilang=&quot;sas&quot;</code>. Below is a simple example.</p>
<div class="sourceCode">
<pre class="sourceCode"><code class="sourceCode">```{r, eval=FALSE, hilang="sas"}
data _null_;
  x = 1;
  put x=;
run;
```</code></pre>
</div>
<p>The source hook just established identifes the SAS code within <code>&lt;textarea&gt;</code> tags and then applys CodeMirror’s Javascript to the entire block of text within the <code>&lt;textarea&gt;</code> tag.</p>
</div>
</div>
<div id="full-example" class="section level2">
<h2>Full Example</h2>
<p>A full example follows — assuming one makes use of <code>header.html</code> and <code>_hilang_setup.Rmd</code>.</p>
<script src="https://gist.github.com/curtisalexander/5cb663ebc4aa02b4a132192267423b53.js"></script>
</div>
<div id="future-work" class="section level2">
<h2>Future Work</h2>
<p>In the future, I would like to consider:</p>
<ul>
<li>Creating my own <a href="http://rmarkdown.rstudio.com/developer_custom_formats.html">custom output format</a></li>
<li>Creating an actual package with everything bound up that can be conveniently installed</li>
<li>See if I can further parameterize the <a href="http://codemirror.net/doc/manual.html#config">configuration options</a> that are passed to the <code>CodeMirror.fromTextArea</code> Javascript function.</li>
</ul>
</div>
